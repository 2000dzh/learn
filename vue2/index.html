<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <title>聚类图层</title>
    <style>
      html,
      body {
        padding: 0;
        margin: 0;
        width: 100%;
        height: 100%;
      }

      .btn {
        position: absolute;
        left: 10px;
        cursor: pointer;
        color: #fff;
        background-color: #16a2d8;
      }
    </style>
  </head>

  <body>
    <div id="map" style="width: 100%; height: 100%"></div>
    <script src="https://map.sgcc.com.cn/maps?v=3.0.0"></script>
    <script>
      var map;
      var serverUrl = "https://map.sgcc.com.cn";

      // 申请的key和sn
      SGMap.tokenTask
        .login("你申请的appKey", "你申请的appSecret")
        .then(function () {
          initMap();
        });

      function initMap() {
        map = new SGMap.Map({
          // 地图绑定的DOM元素ID
          container: "map",
          // 地图样式
          style: "aegis://styles/aegis/Streets",
          // 默认缩放层级
          zoom: 10,
          // 地图中心点
          center: [118.2, 24.5],
          // 地图默认字体
          localIdeographFontFamily: "Microsoft YoHei",
          transition: {
            duration: 300,
            delay: 0
          }
        });

        map.on("load", function (e) {
          // 添加一个geojson类型的数据源，并把cluster属性设置为true，sdk会主动添加point_count、point_count_abbreviated属性到这份数据中
          // point_count是当前聚合点个数，point_count_abbreviated聚合点个数的简写
          map.addSource("themeData", {
            type: "geojson",
            data: "https://map.sgcc.com.cn/products/js-sdk/v3/assets/json/abc2.json",
            cluster: true,
            clusterMaxZoom: 12, // 最大聚类层级
            clusterRadius: 100 // 聚合点半径，默认50
          });
          map.addLayer({
            id: "clusters",
            type: "circle",
            source: "themeData",
            filter: ["has", "point_count"],
            paint: {
              // 使用step表达式，用于分段匹配圆点的颜色和半径
              // 根据当前"point_count"值匹配对应的内容
              // 默认为"#9faebf"
              // 当大于10小于30时，返回"#3583de"
              // 大于30小于55时，返回"#04b71e"
              "circle-color": [
                "step",
                ["get", "point_count"],
                "#9faebf",
                10,
                "#3583de",
                30,
                "#04b71e",
                55,
                "#ff9800",
                100,
                "#f61402",
                300,
                "#f61402"
              ],
              "circle-radius": [
                "step",
                ["get", "point_count"],
                20,
                50,
                30,
                100,
                35,
                500,
                35,
                2000,
                40,
                5000,
                40
              ],
              "circle-opacity": 0.7,
              "circle-stroke-width": 3,
              "circle-stroke-color": "#ffffff"
            }
          });

          map.addLayer({
            id: "clusterCount",
            type: "symbol",
            source: "themeData",
            filter: ["has", "point_count"],
            layout: {
              "text-field": "{point_count_abbreviated}",
              "text-font": ["Microsoft YaHei Regular"],
              "text-size": 14
            },
            paint: {
              "text-color": "#ffffff"
            }
          });

          //监听聚类图点击，并且根据点击的聚合圆展开
          map.on("click", "clusters", function (e) {
            var features = map.queryRenderedFeatures(e.point, {
              layers: ["clusters"]
            });
            var clusterId = features[0].properties.cluster_id;

            map
              .getSource("themeData")
              .getClusterExpansionZoom(clusterId, function (err, zoom) {
                if (err) return;
                map.easeTo({
                  center: features[0].geometry.coordinates,
                  zoom: zoom
                });
              });
          });

          //画图片点，需要先加载图片 图片路径在页面部署在服务上时可以用相对路径
          map.loadImage("https://map.sgcc.com.cn/products/js-sdk/v3/assets/images/bike2.png", function (error, image) {
            //添加图片到map，可以设置图片id
            map.addImage("poi", image);
            map.addLayer({
              id: "choicePoi",
              type: "symbol",
              source: "themeData",
              filter: ["!has", "point_count"],
              layout: {
                "icon-image": "poi",
                "icon-size": 0.8
              },
              paint: {
                "text-color": "#555252",
                "text-halo-color": "#FFFFFF",
                "text-halo-width": 1.33333
              }
            });
          });
        });
      }
    </script>
  </body>
</html>
